############################################################################################
# Makefile for the project deRFnative_Button_LED Release Using single source files
############################################################################################

# Build specific properties
_PAL_TYPE = AT91SAM7X512
_PAL_GENERIC_TYPE = ARM7
_BOARD_TYPE = deRFarm7_15X00_deRFnode

# available memories on target 
MEMORIES = sram flash

## Trace level used
# (can be overriden by adding TRACE_LEVEL=#number to the command-line)
# TRACE_LEVEL_DEBUG      5
# TRACE_LEVEL_INFO       4
# TRACE_LEVEL_WARNING    3
# TRACE_LEVEL_ERROR      2
# TRACE_LEVEL_FATAL      1
# TRACE_LEVEL_NO_TRACE   0
TRACE_LEVEL = 0
DYNTRACE = 0

# verbosity level of compilation, uncomment for verbose make console output
SILENT = true

# Path variables
MAIN_DIR = ../../../../../..
APP_DIR = ../..
PATH_PAL = $(MAIN_DIR)/PAL
PATH_AT91LIB = $(PATH_PAL)/$(_PAL_GENERIC_TYPE)/generic/at91lib
PATH_STARTUP = $(PATH_PAL)/$(_PAL_GENERIC_TYPE)/$(_PAL_TYPE)/Startup
PATH_LDSCRIPTS = $(PATH_PAL)/$(_PAL_GENERIC_TYPE)/$(_PAL_TYPE)/Linker_scripts

# Project name and output files destinations
PROJECT = deRFnative_Button_LED
BIN_DIR = bin
OBJ_DIR = obj
OUTPUT := $(BIN_DIR)/$(PROJECT)


#------------------------------------------------------------------------------
# Toolchain
#------------------------------------------------------------------------------

# Tool suffix when cross-compiling, either 'arm-elf-' or 'arm-none-eabi-'
TOOLCHAIN = arm-none-eabi-
# Compilation tools
CC     = $(TOOLCHAIN)gcc
CP     = $(TOOLCHAIN)objcopy
SIZE   = $(TOOLCHAIN)size
STRIP  = $(TOOLCHAIN)strip

## Options common to compile, link and assembly rules
# General Flags
MCU    = arm7tdmi
COMMON = -mcpu=$(MCU)

# comment out, if debugging / USB interface used
OPTFLAGS = -O0

## Compile options common for all C compilation units.
CFLAGS += $(COMMON) 
CFLAGS += $(INCLUDES)
CFLAGS += -DNOASSERT
CFLAGS += -Wall -Werror -g -Wundef -std=c99 $(OPTFLAGS)
CFLAGS += -Wno-parentheses
CFLAGS += -MD -MP -MT $(*F).o -MF $(OBJ_DIR)/$(@F).d
# AT91-specific
CFLAGS += -mthumb-interwork  
CFLAGS += -fomit-frame-pointer
CFLAGS += -mlong-calls 
CFLAGS += -ffunction-sections
CFLAGS += -DTRACE_LEVEL=$(TRACE_LEVEL)
CFLAGS += -DDYNTRACE=$(DYNTRACE)

## Assembly specific flags
ASMFLAGS += $(COMMON) 
ASMFLAGS += $(CFLAGS)
ASMFLAGS += -x assembler-with-cpp -Wa,-g
ASMFLAGS += -g -gdwarf-2
ASMFLAGS += -D__ASSEMBLY__

## Linker flags
LDFLAGS += $(COMMON) -g $(OPTFLAGS) -nostartfiles -Wl,--gc-sections
LDFLAGS += -Wl,--cref


#------------------------------------------------------------------------------
# Include paths, files to build
#------------------------------------------------------------------------------

# Include directories for PAL
INCLUDES += -I$(MAIN_DIR)/PAL/Inc/
INCLUDES += -I$(MAIN_DIR)/PAL/$(_PAL_GENERIC_TYPE)/Generic/Inc
INCLUDES += -I$(MAIN_DIR)/PAL/$(_PAL_GENERIC_TYPE)/$(_PAL_TYPE)/Boards/
# Include directories for specific boards types
INCLUDES += -I$(MAIN_DIR)/PAL/$(_PAL_GENERIC_TYPE)/$(_PAL_TYPE)/Boards/$(_BOARD_TYPE)
INCLUDES += -I$(MAIN_DIR)/PAL/$(_PAL_GENERIC_TYPE)/$(_PAL_TYPE)/Inc
# AT91Lib 
INCLUDES += -I$(PATH_AT91LIB)/peripherals 
INCLUDES += -I$(PATH_AT91LIB)/components
INCLUDES += -I$(PATH_AT91LIB)/utility
INCLUDES += -I$(PATH_AT91LIB)

## paths to search for source files
VPATH += $(APP_DIR)/Src
VPATH += $(PATH_PAL)/$(_PAL_GENERIC_TYPE)/Generic/Src
VPATH += $(PATH_PAL)/$(_PAL_GENERIC_TYPE)/$(_PAL_TYPE)/Src
VPATH += $(PATH_PAL)/$(_PAL_GENERIC_TYPE)/$(_PAL_TYPE)/Boards/$(_BOARD_TYPE)
VPATH += $(PATH_AT91LIB)/utility
VPATH += $(PATH_AT91LIB)/peripherals
VPATH += $(PATH_AT91LIB)/peripherals/aic
VPATH += $(PATH_AT91LIB)/peripherals/dbgu
VPATH += $(PATH_AT91LIB)/peripherals/pio
VPATH += $(PATH_STARTUP)

## Objects built from C source files
# main application
C_OBJECTS += main.o
# AT91Lib sources
C_OBJECTS += led.o
C_OBJECTS += aic.o
C_OBJECTS += dbgu.o
C_OBJECTS += pio.o
C_OBJECTS += pio_it.o
C_OBJECTS += board_memories.o
C_OBJECTS += board_lowlevel.o

## Objects built from Assembly source files
ASM_OBJECTS = board_cstartup.o


# -----------------------------------------------------------------------------
# make targets and -rules
# -----------------------------------------------------------------------------

all: $(BIN_DIR) $(OBJ_DIR) $(MEMORIES)

$(BIN_DIR) $(OBJ_DIR):
	mkdir $@

define RULES

C_OBJECTS_$(1) = $(addprefix $(OBJ_DIR)/$(1)_, $(C_OBJECTS))
ASM_OBJECTS_$(1) = $(addprefix $(OBJ_DIR)/$(1)_, $(ASM_OBJECTS))

$(1): $$(ASM_OBJECTS_$(1)) $$(C_OBJECTS_$(1))
	@echo --------------------------------------------------------------------
	@echo linking
	@echo --------------------------------------------------------------------
	$(CC) $(LDFLAGS) -T$(PATH_LDSCRIPTS)/$$@.lds -Wl,-Map=$(OUTPUT)-$$@.map \
					-o $(OUTPUT)-$$@.elf $$^
	@echo --------------------------------------------------------------------
	@echo creating BIN file
	@echo --------------------------------------------------------------------
	$(CP) -O binary $(OUTPUT)-$$@.elf $(OUTPUT)-$$@.bin
	@echo --------------------------------------------------------------------
	@echo determine file size
	@echo --------------------------------------------------------------------
	@-$(SIZE) $$^ $(OUTPUT)-$$@.elf

$$(C_OBJECTS_$(1)): $(OBJ_DIR)/$(1)_%.o: %.c Makefile $(OBJ_DIR) $(BIN_DIR)
ifeq ($(SILENT),true)
	@echo compiling $$@
	@-$(CC) $(CFLAGS) -D$(1) -c -o $$@ $$<
else
	$(CC) $(CFLAGS) -D$(1) -c -o $$@ $$<	
endif

$$(ASM_OBJECTS_$(1)): $(OBJ_DIR)/$(1)_%.o: %.S Makefile $(OBJ_DIR) $(BIN_DIR)
ifeq ($(SILENT),true)
	@echo compiling $$@
	@-$(CC) $(ASMFLAGS) -D$(1) -c -o $$@ $$<
else
	$(CC) $(ASMFLAGS) -D$(1) -c -o $$@ $$<
endif	

endef

$(foreach MEMORY, $(MEMORIES), $(eval $(call RULES,$(MEMORY))))

clean:
	-rm -f $(OBJ_DIR)/*.o $(OBJ_DIR)/*.lst $(OBJ_DIR)/.d -r $(OBJ_DIR)/.dep
	-rm -f $(BIN_DIR)/*.bin $(BIN_DIR)/*.elf $(BIN_DIR)/*.map
	

# Include the dependency files, should be the last of the makefile
-include $(shell mkdir $(OBJ_DIR)/.dep 2>/dev/null) $(wildcard  $(OBJ_DIR)/.dep/*)

# *** EOF ***
